pipeline {
  agent any

  tools {
    nodejs 'node24'
  }

  environment {
    BUN_INSTALL = "%USERPROFILE%\\.bun"
    PATH = "%USERPROFILE%\\.bun\\bin;%PATH%"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Verify Node') {
      steps {
        bat '''
          node -v
          npm -v
        '''
      }
    }

    stage('Install Bun') {
      steps {
        bat '''
          where bun >nul 2>nul
          if %ERRORLEVEL% NEQ 0 (
            powershell -Command "irm https://bun.sh/install.ps1 | iex"
          )
          bun -v
        '''
      }
    }

    stage('Install Dependencies') {
      steps {
        bat 'bun install'
      }
    }

    stage('Build Next.js App') {
  steps {
    bat 'bun run build'
  }
}

stage('Start App For Testing') {
  steps {
    bat '''
      pm2 stop continuum-test || echo "No existing test process"
      pm2 delete continuum-test || echo "No existing test process"
      pm2 start node_modules\\.bin\\next.cmd --name continuum-test -- start -p 3001
    '''
  }
}

stage('Wait for App') {
  steps {
    bat '''
      timeout /t 10
    '''
  }
}

stage('Run E2E Tests') {
  steps {
    bat '''
      set BASE_URL=http://localhost:3001
      bun run test:e2e
    '''
  }
}

stage('Stop Test App') {
  steps {
    bat '''
      pm2 stop continuum-test
      pm2 delete continuum-test
    '''
  }
}

    stage('Deploy with PM2') {
  steps {
    bat '''
      :: Stop existing PM2 process
      pm2 stop continuum || echo "No existing PM2 process"
      pm2 delete continuum || echo "No existing PM2 process"

      :: Start Next.js app with PM2
      pm2 start node_modules\\.bin\\next.cmd --name continuum -- start -p 3000
      pm2 save
    '''
  }
}
stage('Reload Nginx') {
  steps {
        bat '"C:\\nginx\\nginx.exe" -p "C:\\nginx" -s reload'
  }
}

  }

  post {
    success {
      echo '✅ Windows + Node 24 + Bun + Next.js build successful'
    }
    failure {
      echo '❌ Build failed'
    }
  }
}
