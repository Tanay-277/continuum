pipeline {
    agent any

    // Only needed if NodeJS Plugin installed. Otherwise remove this block.
    tools {
        nodejs 'node24'
    }

    environment {
        // Bun
        BUN_INSTALL = "%USERPROFILE%\\.bun"
        PATH = "%USERPROFILE%\\.bun\\bin;%PATH%"

        // Test app
        TEST_PORT = "3001"

        // PM2 home directory (required for Windows service Jenkins)
        PM2_HOME = "C:\\pm2home"

        // Production app port
        PROD_PORT = "3000"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Verify Node') {
            steps {
                bat '''
                    node -v
                    npm -v
                '''
            }
        }

        stage('Install Bun') {
            steps {
                bat '''
                    where bun >nul 2>nul
                    if %ERRORLEVEL% NEQ 0 (
                        powershell -Command "irm https://bun.sh/install.ps1 | iex"
                    )
                    bun -v
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                bat 'bun install'
            }
        }

        stage('Build Next.js App') {
            steps {
                bat 'bun run build'
            }
        }
stage('Start App For Testing') {
  steps {
    bat '''
      REM Start temporary Next.js app for E2E tests using Node
pm2 start "bun" --name continuum-test -- run start -- --port %TEST_PORT% --update-env
    '''
  }
}




        stage('Wait For App') {
            steps {
                bat 'timeout /t 10'
            }
        }

        stage('Run E2E Tests') {
            steps {
                bat '''
                    set BASE_URL=http://localhost:%TEST_PORT%
                    bun run test:e2e || exit /b 1
                '''
            }
        }

    stage('Stop Test App') {
  steps {
    bat '''
      pm2 delete continuum-test >nul 2>nul || exit /b 0
    '''
  }
}



        stage('Deploy Production App') {
            steps {
                bat '''
                    REM Stop & delete existing production app safely
                    pm2 stop continuum >nul 2>nul || echo "No existing production process"
                    pm2 delete continuum >nul 2>nul || echo "No existing production process"

                    REM Start production app on PROD_PORT
                    pm2 start node_modules\\.bin\\next.cmd --name continuum -- start -p %PROD_PORT%
                    pm2 save
                '''
            }
        }

        stage('Reload Nginx') {
            steps {
                bat '"C:\\nginx\\nginx.exe" -p "C:\\nginx" -s reload'
            }
        }
    }

    post {
        always {
            bat '''
                REM Cleanup temp test app in case something failed
                pm2 stop continuum-test >nul 2>nul || echo "No test process"
                pm2 delete continuum-test >nul 2>nul || echo "No test process"
            '''
        }

        success {
            echo '✅ CI/CD Pipeline Successful: Build + E2E + Deploy'
        }

        failure {
            echo '❌ CI/CD Pipeline Failed'
        }
    }
}
