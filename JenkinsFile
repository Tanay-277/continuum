pipeline {
  agent any

  tools {
    nodejs 'node24'
  }

  environment {
    BUN_INSTALL = "%USERPROFILE%\\.bun"
    PATH = "%USERPROFILE%\\.bun\\bin;%PATH%"
    TEST_PORT = "3001"
    PM2_HOME = "C:\\pm2home"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Verify Node') {
      steps {
        bat '''
          node -v
          npm -v
        '''
      }
    }

    stage('Install Bun') {
      steps {
        bat '''
          where bun >nul 2>nul
          if %ERRORLEVEL% NEQ 0 (
            powershell -Command "irm https://bun.sh/install.ps1 | iex"
          )
          bun -v
        '''
      }
    }

    stage('Install Dependencies') {
      steps {
        bat 'bun install'
      }
    }

    stage('Build Next.js App') {
      steps {
        bat 'bun run build'
      }
    }

    stage('Start App For Testing') {
      steps {
        bat '''
          pm2 delete continuum-test >nul 2>nul
          pm2 start node_modules\\.bin\\next.cmd --name continuum-test -- start -p %TEST_PORT%
        '''
      }
    }

    stage('Wait for App') {
      steps {
        bat 'timeout /t 10'
      }
    }

    stage('Run E2E Tests') {
      steps {
        bat '''
          set BASE_URL=http://localhost:%TEST_PORT%
          bun run test:e2e
        '''
      }
    }

    stage('Stop Test App') {
      steps {
        bat '''
          pm2 delete continuum-test >nul 2>nul
          exit /b 0
        '''
      }
    }

    stage('Deploy with PM2') {
      steps {
        bat '''
          pm2 delete continuum >nul 2>nul
          pm2 start node_modules\\.bin\\next.cmd --name continuum -- start -p 3000
          pm2 save
        '''
      }
    }

    stage('Reload Nginx') {
      steps {
        bat '"C:\\nginx\\nginx.exe" -p "C:\\nginx" -s reload'
      }
    }

  }

  post {
    success {
      echo '✅ Build + E2E + Deploy successful'
    }
    failure {
      echo '❌ Build failed'
    }
  }
}
