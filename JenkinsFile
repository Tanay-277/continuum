pipeline {
    agent any

    // Only needed if NodeJS Plugin installed. Otherwise remove this block.
    tools {
        nodejs 'node24'
    }

    environment {
        // Bun
        BUN_INSTALL = "%USERPROFILE%\\.bun"
        PATH = "%USERPROFILE%\\.bun\\bin;%PATH%"

        // Test app
        TEST_PORT = "3001"

        // PM2 home directory (required for Windows service Jenkins)
        PM2_HOME = "C:\\pm2home"

        // Production app port
        PROD_PORT = "3000"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Verify Node') {
            steps {
                bat '''
                    node -v
                    npm -v
                '''
            }
        }

        stage('Install Bun') {
            steps {
                bat '''
                    where bun >nul 2>nul
                    if %ERRORLEVEL% NEQ 0 (
                        REM Bun install fallback (requires powershell)
                        echo "Bun not found. Please install manually if powershell is missing."
                    )
                    bun -v
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                bat 'bun install'
            }
        }

        stage('Build Next.js App') {
            steps {
                bat 'bun run build'
            }
        }

        stage('Start App For Testing') {
            steps {
                bat '''
                    REM Start temporary test app for E2E using NodeJS (safe on Windows Jenkins)
                    pm2 start node "node_modules/next/dist/bin/next" --name continuum-test -- start -p %TEST_PORT% --update-env || exit /b 1
                '''
            }
        }

        stage('Wait For App') {
            steps {
                bat '''
                    REM Wait 10 seconds for app to start using NodeJS (works in Jenkins Windows service)
                    node -e "setTimeout(() => {}, 10000)"
                '''
            }
        }

        stage('Run E2E Tests') {
            steps {
                bat '''
                    set BASE_URL=http://localhost:%TEST_PORT%
                    bun run test:e2e || exit /b 1
                '''
            }
        }

        stage('Stop Test App') {
            steps {
                bat '''
                    REM Stop & delete temp test app safely
                    pm2 delete continuum-test >nul 2>nul || exit /b 0
                '''
            }
        }

        stage('Deploy Production App') {
            steps {
                bat '''
                    REM Stop & delete existing production app safely
                    pm2 stop continuum >nul 2>nul || exit /b 0
                    pm2 delete continuum >nul 2>nul || exit /b 0

                    REM Start production app safely (NodeJS path, works with Bun)
                    pm2 start node "node_modules/next/dist/bin/next" --name continuum -- start -p %PROD_PORT%
                    pm2 save
                '''
            }
        }

        stage('Reload Nginx') {
            steps {
                bat '"C:\\nginx\\nginx.exe" -p "C:\\nginx" -s reload'
            }
        }
    }

    post {
        always {
            bat '''
                REM Cleanup temp test app just in case
                pm2 stop continuum-test >nul 2>nul || exit /b 0
                pm2 delete continuum-test >nul 2>nul || exit /b 0
            '''
        }

        success {
            echo '✅ CI/CD Pipeline Successful: Build + E2E + Deploy'
        }

        failure {
            echo '❌ CI/CD Pipeline Failed'
        }
    }
}
